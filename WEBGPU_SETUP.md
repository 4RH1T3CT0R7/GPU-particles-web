# WebGPU Ray Tracing -- Руководство по настройке

## Быстрый старт

### Требования

**Поддержка WebGPU:**
- Chrome Canary 113+ или Chrome Dev channel
- Включите флаг WebGPU: `chrome://flags/#enable-unsafe-webgpu`
- Альтернативно: Chrome 113+ стабильная версия (WebGPU включен по умолчанию в некоторых регионах)

**Система:**
- Современная видеокарта (NVIDIA серии 10+, AMD RX 5000+, Intel Arc)
- Рекомендуется 4 ГБ+ видеопамяти
- Windows 10/11, macOS или Linux

### Установка

1. **Клонируйте репозиторий:**
```bash
git clone https://github.com/4RH1T3CT0R7/GPU-particles-web.git
cd GPU-particles-web
```

2. **Установите зависимости:**
```bash
npm install
```

3. **Соберите проект:**
```bash
npm run build
```

Эта команда собирает WASM-модуль физического движка XPBD и бандлит TypeScript-код через esbuild.

4. **Запустите сервер разработки:**
```bash
npm run dev
```

5. **Откройте в браузере:**
```
http://localhost:8080/index-webgpu.html
```

---

## Две доступные версии

### Версия WebGL2 (Стабильная)
**URL:** `http://localhost:8080/index.html`

**Возможности:**
- PBR-освещение (Cook-Torrance BRDF)
- Несколько динамических источников света (4 источника)
- HDR-рендеринг + тональная компрессия ACES
- Улучшенный блум
- Работает во всех современных браузерах

**Используйте, когда:**
- WebGPU недоступен
- Нужна максимальная совместимость
- Мобильные устройства

### Версия WebGPU (Экспериментальная -- трассировка лучей)
**URL:** `http://localhost:8080/index-webgpu.html`

**Возможности:**
- **Трассировка лучей в реальном времени**
- **Тени на основе трассировки лучей**
- **Path tracing с GI с 1 отскоком -- АКТИВНО**
- **Темпоральная аккумуляция для шумоподавления -- АКТИВНО**
- **Материалы для каждой частицы (с вариациями) -- АКТИВНО**
- **Importance sampling (GGX specular)**
- **Излучающие частицы**
- BVH-ускоряющая структура (упрощенная, динамическая)
- Симуляция частиц на вычислительных шейдерах
- PBR-затенение (Cook-Torrance BRDF)
- До 8 динамических источников света
- HDR + тональная компрессия ACES
- Интеграция с WASM-физическим движком XPBD

**Используйте, когда:**
- WebGPU доступен
- Хотите передовую графику
- Тестируете возможности трассировки лучей

---

## Интеграция физического движка WASM

Проект включает физический движок XPBD, написанный на Rust и скомпилированный в WebAssembly. Движок обеспечивает:

- Солвер XPBD с подшагами и итерациями Якоби
- 5 типов ограничений (distance, contact, density, shape matching, bending)
- N-тельная гравитация Барнса-Хата O(N log N)
- Электромагнитные силы (Кулон + Лоренц)
- PBF-гидродинамика с XSPH-вязкостью
- 13 математических форм + фрактальный генератор
- Пространственная хеш-сетка для запросов соседей за O(N)

Для пересборки только WASM-модуля:
```bash
cd physics/crates/xpbd-wasm
wasm-pack build --target web
```

---

## Устранение неполадок

### WebGPU недоступен

**Chrome:**
1. Перейдите на `chrome://gpu`
2. Проверьте, что "WebGPU" показывает "Hardware accelerated"
3. Если нет, попробуйте включить: `chrome://flags/#enable-unsafe-webgpu`
4. Перезапустите браузер

**Firefox:**
- Поддержка WebGPU появится в ближайшее время (пока используйте Chrome)

**Safari:**
- WebGPU частично поддерживается в Safari Technology Preview

### Автоматический откат

Если WebGPU недоступен, приложение автоматически:
1. Обнаруживает доступность WebGPU
2. Показывает сообщение об откате
3. Загружает версию WebGL2 вместо этого

Ручное вмешательство не требуется.

### Черный экран

**Возможные причины:**
1. **Ошибка компиляции шейдера:**
   - Откройте консоль DevTools (F12)
   - Найдите ошибки WebGPU
   - Сообщите о проблеме с текстом ошибки

2. **Буфер BVH не инициализирован:**
   - Это ожидаемо в текущей версии
   - Используется упрощенный BVH
   - Полное построение BVH запланировано

3. **GPU занят/сбой:**
   - Закройте другие вкладки с высокой нагрузкой на GPU
   - Уменьшите количество частиц (измените `index-webgpu.js`, строка 61)
   - Снизьте разрешение

### Проблемы с производительностью

**Если FPS < 30:**

1. **Уменьшите количество частиц:**
```javascript
// В index-webgpu.js, строка 61
const config = {
  particleCount: 16384, // Вместо 65536
  ...
}
```

2. **Снизьте разрешение:**
```javascript
// В index-webgpu.js, строка 62-63
const config = {
  ...
  width: Math.floor(canvas.clientWidth * 0.5), // 50% разрешения
  height: Math.floor(canvas.clientHeight * 0.5),
  ...
}
```

3. **Временно отключите тени:**
```wgsl
// В src/shaders-wgsl/ray-trace.wgsl, строка 298
// Закомментируйте тестирование теневых лучей:
// let inShadow = traceShadowRay(shadowRay, lightDist);
let inShadow = false; // Принудительно отключить тени
```

---

## Управление

Текущие элементы управления:
- Перетаскивание правой кнопкой мыши: вращение камеры
- Колесо мыши: приближение/отдаление
- Перетаскивание левой кнопкой мыши: взаимодействие с частицами
- 7 режимов взаимодействия с указателем (притяжение, отталкивание, вихрь Л/П, импульс, магнитный поток, квазар)

---

## Бенчмарки производительности

**Ожидаемый FPS (WebGPU):**

| GPU | 1080p | 1440p | 4K |
|-----|-------|-------|-----|
| RTX 4090 | 144+ | 120+ | 60+ |
| RTX 3080 | 90+ | 60+ | 30+ |
| RTX 2060 | 60 | 45 | 20 |
| AMD RX 6800 | 80+ | 60+ | 35+ |

*65K частиц, тени трассировки лучей включены*

**Ожидаемый FPS (WebGL2):**

Более стабильный, 60 FPS на большинстве современных GPU.

---

## Расширенное тестирование

### Включение многоотскоковых отражений

1. Откройте `src/shaders-wgsl/ray-trace.wgsl`
2. Найдите строку 280 (в главной функции)
3. Раскомментируйте код отскока GI:
```wgsl
// Простой GI с 1 отскоком (опционально, ресурсоемко)
let seed = vec3<f32>(f32(pixelCoord.x), f32(pixelCoord.y), params.time);
let bounceDir = randomHemisphere(hit.normal, seed);
var bounceRay: Ray;
bounceRay.origin = hit.position + hit.normal * 0.001;
bounceRay.direction = bounceDir;
let bounceHit = traceBVH(bounceRay);
if (bounceHit.hit) {
    color += albedo * 0.1; // Упрощенное непрямое освещение
}
```
4. Обновите страницу

### Настройка экспозиции/гаммы

Измените `src/gpu/pipelines.js`, строка 323:
```javascript
const uniformsData = new Float32Array([
  0.5,  // экспозиция (по умолчанию: 0.2)
  2.4   // гамма (по умолчанию: 2.2)
]);
```

### Изменение количества источников света

Измените `index-webgpu.js`, строки 73-77:
```javascript
const lights = [
  { pos: [2, 3, 2], color: [1.0, 0.9, 0.8], intensity: 3.0, radius: 20.0 },
  // Добавьте больше источников (до 8 всего)
];
```

---

## Известные проблемы

1. **Построение BVH:**
   - ИСПРАВЛЕНО: BVH теперь строится динамически каждый кадр
   - Текущее состояние: упрощенная плоская структура (быстрая, но не оптимальная)
   - Полный LBVH на кодах Мортона запланирован в Фазе 4
   - Трассировка лучей работает и ускорена

2. **Темпоральная аккумуляция:**
   - РЕАЛИЗОВАНО: темпоральное AA-шумоподавление активно
   - Экспоненциальное скользящее среднее с настраиваемой альфой
   - Эффективно сглаживает шум path tracing
   - Буфер истории поддерживается между кадрами

3. **Шумоподавление:**
   - Базовое темпоральное шумоподавление работает
   - Продвинутый SVGF еще не реализован
   - Качество изображения значительно улучшено по сравнению с отсутствием шумоподавления
   - Дальнейшие улучшения в Фазе 4

4. **Path Tracing:**
   - GI с 1 отскоком активен и работает
   - Код для 2-3 отскоков готов, но отключен (производительность)
   - Importance sampling снижает шум
   - Количество сэмплов на пиксель = 1 (темпоральная аккумуляция компенсирует)

5. **Мобильные устройства:**
   - WebGPU пока не поддерживается широко на мобильных
   - Автоматический откат на WebGL2

---

## Технические подробности

### Конвейер трассировки лучей

1. **Симуляция частиц** (Compute)
   - 65K частиц
   - Силы: гравитация, притяжение к форме, curl noise
   - Обновление позиций/скоростей
   - Интеграция с WASM-физикой XPBD (солвер ограничений, N-тельная гравитация, электромагнитные силы)

2. **Построение BVH** (Compute -- упрощенное)
   - Построение ускоряющей структуры
   - Пространственное хеширование кодами Мортона
   - Текущая реализация упрощена

3. **Трассировка лучей** (Compute)
   - Генерация лучей из камеры
   - Обход BVH (стек на 32 уровня)
   - Пересечение луча и сферы
   - Теневые лучи для каждого источника света
   - PBR-затенение (Cook-Torrance)

4. **Тональная компрессия** (Render)
   - Тональная компрессия ACES
   - Гамма-коррекция
   - Вывод на холст

### Файлы шейдеров

```
src/shaders-wgsl/
├── common.wgsl          # Математика, шум, хеш-функции
├── pbr.wgsl             # Функции PBR BRDF
├── particle-sim.wgsl    # Физика частиц
├── bvh-build.wgsl       # Построение BVH
├── ray-trace.wgsl       # Ядро трассировки лучей
└── blit.wgsl            # Финальный вывод с тональной компрессией
```

---

## Дорожная карта

### Фаза 1 -- ЗАВЕРШЕНА
- [x] Инициализация WebGPU
- [x] Вычислительная симуляция частиц
- [x] Структура BVH (упрощенная)
- [x] Ядро трассировки лучей
- [x] Тени на основе трассировки
- [x] PBR-освещение
- [x] Тональная компрессия

### Фаза 2 -- ЗАВЕРШЕНА
- [x] Упрощенное построение BVH (динамическое, каждый кадр)
- [x] Многоотскоковые отражения (активен 1 отскок)
- [x] Path tracing для GI (работает)
- [x] Темпоральная аккумуляция (шумоподавление активно)
- [x] Система материалов для каждой частицы
- [x] Importance sampling (GGX)
- [x] Излучающие частицы

### Фаза 3 -- ЗАВЕРШЕНА
- [x] Физический движок XPBD на Rust/WASM
- [x] 5 типов ограничений (distance, contact, density, shape matching, bending)
- [x] N-тельная гравитация Барнса-Хата
- [x] Электромагнитные силы (Кулон + Лоренц)
- [x] PBF-гидродинамика + XSPH-вязкость + подавление вихрей
- [x] 13 математических форм + фрактальный генератор
- [x] 7 режимов взаимодействия с указателем
- [x] Аудиореактивные силы
- [x] Адаптивный контроллер качества
- [x] Миграция на TypeScript + esbuild
- [x] 154 теста, ноль предупреждений

### Фаза 4 -- ЗАПЛАНИРОВАНА
- [ ] Шумоподавление SVGF
- [ ] Трассированное фоновое затенение (RTAO)
- [ ] Объемное освещение
- [ ] Элементы управления UI

### Фаза 5 -- ЗАПЛАНИРОВАНА
- [ ] Адаптивная выборка
- [ ] Система LOD
- [ ] Профилировщик производительности
- [ ] Пресеты качества

---

## Участие в разработке

Обратная связь приветствуется.

**При сообщении о проблемах указывайте:**
- Версию браузера
- Модель GPU
- Ошибки в консоли
- Скриншоты

---

## Лицензия

MIT License -- см. LICENSE.md

---

*Последнее обновление: 2026-02-19*
*Версия: 4.0 -- Path Tracing + Темпоральное AA + Физика XPBD*
*Фаза 3 завершена: физический движок XPBD, TypeScript, WASM-интеграция*
